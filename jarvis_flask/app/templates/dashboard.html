{% extends "base.html" %}

{% block title %}User Dashboard{% endblock %}

{% block header %}
<div style="position: relative; text-align: right; padding: 10px 20px;">
    <a href="{{ url_for('logout') }}" style="padding: 10px 15px; background: linear-gradient(90deg, #ff4d4d, #ff0000); color: white; text-decoration: none; font-size: 0.9rem; font-weight: bold; border-radius: 5px; box-shadow: 0px 4px 10px rgba(255, 0, 0, 0.3); transition: 0.3s;">
        Logout
    </a>
    {% if role == 'admin' %}
    <a href="{{ url_for('admin_dashboard') }}" style="padding: 10px 15px; background: linear-gradient(90deg, #00c6ff, #0072ff); color: white; text-decoration: none; font-size: 0.9rem; font-weight: bold; border-radius: 5px; box-shadow: 0px 4px 10px rgba(0, 198, 255, 0.3); transition: 0.3s; margin-left: 10px;">
        Admin Dashboard
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="user-dashboard-container" style="background: radial-gradient(circle at top, #1a1a2e, #0f0f1b); color: white; padding: 40px; border-radius: 15px; box-shadow: 0px 0px 30px rgba(0, 212, 255, 0.4);">
    <h1 class="text-4xl font-bold text-center mb-6" style="color: #00d4ff; text-shadow: 0 0 25px rgba(0, 212, 255, 0.8), 0 0 50px rgba(0, 212, 255, 0.5);">Welcome to Your Dashboard</h1>

    <!-- Success Message -->
    <div class="success-message" style="background: rgba(0, 212, 255, 0.1); color: #00d4ff; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; box-shadow: 0px 0px 10px rgba(0, 212, 255, 0.3);">
        Welcome, {{ username }}!
    </div>

    <!-- Jarvis Control Panel -->
    <div class="control-panel" style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; margin-top: 30px;">
        <h2 style="color: #00d4ff; margin-bottom: 15px;">Jarvis Control Panel</h2>
        <p style="margin-bottom: 20px;">Click the button below to activate Jarvis</p>

        <button id="activate-jarvis" style="padding: 15px 25px; background: linear-gradient(90deg, #0062ff, #00c6ff); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0px 4px 15px rgba(0, 198, 255, 0.5);">
            Activate Jarvis
        </button>

        <!-- Loading Animation (hidden by default) -->
        <div id="loading-animation" style="display: none; margin-top: 20px; text-align: center;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid rgba(0, 212, 255, 0.2); border-radius: 50%; border-top-color: #00d4ff; animation: spin 1s ease-in-out infinite;"></div>
            <p style="margin-top: 10px; color: #00d4ff;">Initializing Jarvis...</p>
        </div>

        <div id="status-message" style="margin-top: 15px; font-size: 0.9rem; color: #aaa;"></div>

        <!-- Jarvis Output Terminal -->
        <div id="jarvis-terminal" style="display: none; margin-top: 20px; background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 15px; border-radius: 8px; height: 300px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5;">
            <div id="jarvis-output"></div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</div>

<script>
document.getElementById('activate-jarvis').addEventListener('click', function() {
    const statusMessage = document.getElementById('status-message');
    const jarvisTerminal = document.getElementById('jarvis-terminal');
    const jarvisOutput = document.getElementById('jarvis-output');
    const loadingAnimation = document.getElementById('loading-animation');

    // Clear previous output
    jarvisOutput.innerHTML = '';

    // Hide status message and show loading animation
    statusMessage.textContent = '';
    loadingAnimation.style.display = 'block';

    // Show terminal
    jarvisTerminal.style.display = 'block';

    // Get CSRF token
    const csrfToken = "{{ csrf_token() }}";

    // Disable button while processing
    this.disabled = true;

    fetch('{{ url_for("run_jarvis") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable button after a short delay
        setTimeout(() => {
            this.disabled = false;
        }, 3000);

        // Hide loading animation
        loadingAnimation.style.display = 'none';

        if (data.status === 'success' || data.status === 'timeout') {
            // Update status message
            statusMessage.textContent = data.message;
            statusMessage.style.color = data.status === 'success' ? '#00ff7f' : '#ffaa00';

            // Display output in terminal
            if (data.output && data.output.length > 0) {
                // Simulate typing effect for each line
                let lineIndex = 0;

                function typeLine() {
                    if (lineIndex < data.output.length) {
                        const line = data.output[lineIndex];
                        if (line.trim()) {  // Only process non-empty lines
                            const lineElement = document.createElement('div');
                            jarvisOutput.appendChild(lineElement);

                            let charIndex = 0;
                            const typingInterval = setInterval(() => {
                                if (charIndex < line.length) {
                                    lineElement.textContent += line[charIndex];
                                    charIndex++;
                                    // Auto-scroll to bottom
                                    jarvisTerminal.scrollTop = jarvisTerminal.scrollHeight;
                                } else {
                                    clearInterval(typingInterval);
                                    lineIndex++;
                                    setTimeout(typeLine, 100);  // Delay between lines
                                }
                            }, 30);  // Typing speed
                        } else {
                            // Skip empty lines
                            lineIndex++;
                            setTimeout(typeLine, 50);
                        }
                    }
                }

                // Start typing animation
                typeLine();
            }

            // Display error if any
            if (data.error) {
                const errorElement = document.createElement('div');
                errorElement.style.color = '#ff4d4d';
                errorElement.textContent = 'Error: ' + data.error;
                jarvisOutput.appendChild(errorElement);
            }
        } else {
            // Hide loading animation
            loadingAnimation.style.display = 'none';

            // Display error
            statusMessage.textContent = 'Error: ' + data.message;
            statusMessage.style.color = '#ff4d4d';

            const errorElement = document.createElement('div');
            errorElement.style.color = '#ff4d4d';
            errorElement.textContent = 'Failed to activate Jarvis: ' + data.message;
            jarvisOutput.appendChild(errorElement);
        }
    })
    .catch(error => {
        // Re-enable button
        this.disabled = false;

        // Hide loading animation
        loadingAnimation.style.display = 'none';

        // Display error
        statusMessage.textContent = 'Error: ' + error.message;
        statusMessage.style.color = '#ff4d4d';

        const errorElement = document.createElement('div');
        errorElement.style.color = '#ff4d4d';
        errorElement.textContent = 'Connection error: ' + error.message;
        jarvisOutput.appendChild(errorElement);
    });
});
</script>
{% endblock %}
